# UserRegistrationServer

UserRegistrationServer е web, клиент-сървър приложение, създадено без използването на каквито и да е frameworks и външни услуги.

## Технологии
За създаването на приложението съм избрал:
- **C#** за сървърната логика и писане на тестове.
- **HTML, CSS, JS** за клиентската част. JavaScript се използва за изпращане на request-и към сървъра, които съдържат JSON файлове с нужните данни, както и за генериране на captcha.

## Структура на кода
Приложението е разделено на два проекта:
- **UserRegistrationServer** – съдържа `wwwroot`, `data`, `services`, `repositories`. Тук се намира кодът на приложението.
- **UserRegistrationTests** – съдържа NUnit тестовете.  

За приложението е използван стандартен repository design pattern и многослойна архитектура. Макар да нямам възможност да ползвам готовите ASP.NET функционалности, съм постигнал достатъчно гъвкава система, която ще е лесна за разширение в бъдеще.

## Реализация
Приложението е реализирано по следния начин:
- В **Program.cs** указвам на кой порт да слуша сървърната част. При подаден request се маршрутизира през `UserController` според получените данни.
- Чрез `UserService` се реализира бизнес логиката и валидацията. Повечето методи са асинхронни или подготвени за асинхронна работа в бъдеще, така че при добавяне на истински асинхронни операции не е нужно пренаписване на кода.

## Функционалности
- Регистрация на профил с валидация и запис в MySQL база данни. Паролата се хешира.
- Генериране на custom captcha без използването на външен ресурс.
- Вход/изход в/от профил. След вход, потребителят се пази като JSON; при изход JSON файлът се премахва.
- Редакция на име и смяна на парола.
- Пълно покритие с тестове:
  - `UserRepository` – интеграционни тестове с реална MySQL база.
  - `UserService` – NUnit тестове с Moq, за да не зависи от `UserRepository`.

## Подробно описание

### Program.cs
- Стартира приложението, отваря порт и инициализира services и контролери.
- Един безкраен цикъл слуша за заявки от клиента.
- `ServeStaticFileAsync` връща конкретна страница с CSS и JS файловете ѝ.

### /controllers
- UserController:
  - Използва `UserService` чрез Dependency Injection.
  - Методи получават `HttpListenerContext`, който дава достъп до request-а и неговото тяло. След обработка от `UserService`, контролерът връща JSON отговор.
  - **Register** и **Login** връщат `RegisterResult` и `LoginResult`, които съдържат потребител, успех/неуспех и грешки. При успешна регистрация или вход те задават Jwt token на съответния потребител.
  - **UpdateNames** и **UpdatePassword** връщат променения потребител или хвърлят изключение при проблем, като преди това проверяват дали потребителят има валиден Jwt token.
  - Private методите обхващат логиката за четене/писане на JSON.

### /data
- **Context** – подсигурява връзка с базата, създава база и таблици при нужда. Статичният метод Init позволява работа с тестова база за интеграционни тестове aко е зададена съответната environment променлива.
- **LoginResult, RegisterResult** – модели за резултатите от регистрация и вход.
- **User** – модел на потребител за клиентската част.

### /repositories
- **IUserRepository** – интерфейс за repository.
- **UserRepository** – пише/чете в/от базата данни чрез имплементацията на асинхронни операции, защитава от SQL injection чрез параметризиране на заявките (`cmd.Parameters.AddWithValue`).

### /services
- **PasswordManager** – хеширане и добавяне на сол и валидация на пароли с PBKDF2 (`Rfc2898DeriveBytes`), проверка на паролата.
- **JwtManager** – генерира и валидира JWT токени за автентикация на потребители. Съдържа логика за създаване на токен с изтичане и проверка на подписа чрез секретен ключ, user.secrets.
- **UserService** – бизнес логика и валидация между repository и контролера.

### /wwwroot
- Клиентската част – HTML страници и `style.css`.
- JS файловете са добавени в `head` или `body` според логиката за зареждане и event trigger-и. Всички JS файлове са сложени в `body` с изключение на captcha.js, който зарежда преди самата страница, за да генерира нужния текст.

### /UserRegistrationTests
- Стандартни MSBuild/NUnit тестове:
  - `UserRepository` – интеграционни тестове срещу тестова MySQL база.
  - `UserService` – Moq се използва за тестване на бизнес логиката без зависимост от `UserRepository`.
  - `PasswordManager` - тества се дали правилно валидира, хешира и верифицира дадена парола.
  - `JwtManager` - тества се дали правилно извлича имейл от токен и дали при проблем го засича.
